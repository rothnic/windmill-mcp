name: Generate, Test, and Publish MCP Server

on:
  workflow_dispatch:
    inputs:
      windmill_version:
        description: 'Windmill version (e.g., v1.520.1 or "latest")'
        required: true
        default: 'latest'
        type: string
      publish:
        description: 'Publish to npm after successful tests'
        required: false
        default: true
        type: boolean
  schedule:
    - cron: '0 0 * * 1'  # Run weekly on Mondays at midnight UTC

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-test-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for versioning

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Start Windmill instance
        run: |
          echo "ðŸš€ Starting Windmill instance..."
          npm run docker:up

      - name: Wait for Windmill to be ready
        run: |
          echo "â³ Waiting for Windmill to be ready..."
          npm run docker:wait
        timeout-minutes: 5

      - name: Fetch OpenAPI spec from Windmill
        id: fetch-spec
        run: |
          echo "ðŸ“¥ Fetching OpenAPI spec from running Windmill instance..."

          # Ensure cache directory exists
          mkdir -p generator/cache

          # Fetch from local Windmill instance
          curl -f http://localhost:8000/api/openapi.json -o generator/cache/openapi-spec.json

          # Extract version from spec
          SPEC_VERSION=$(node -p "JSON.parse(require('fs').readFileSync('generator/cache/openapi-spec.json', 'utf8')).info.version")
          echo "spec_version=$SPEC_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Fetched OpenAPI spec version: $SPEC_VERSION"

      - name: Calculate version and branch
        id: version
        run: |
          SPEC_VERSION="${{ steps.fetch-spec.outputs.spec_version }}"
          INPUT_VERSION="${{ github.event.inputs.windmill_version || 'latest' }}"

          # Determine branch name
          if [ "$INPUT_VERSION" = "latest" ]; then
            BRANCH="windmill-latest"
          else
            BRANCH="windmill-$INPUT_VERSION"
          fi

          echo "target_branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Target branch: $BRANCH (OpenAPI version: $SPEC_VERSION)"

          # Calculate next iteration number by checking existing tags
          # Format: v{spec_version}-mcp.{iteration}
          BASE_VERSION="$SPEC_VERSION-mcp"

          # Fetch all tags
          git fetch --tags

          # Find highest iteration for this Windmill version
          HIGHEST_ITERATION=$(git tag -l "v${BASE_VERSION}.*" | \
            sed "s/v${BASE_VERSION}\.//" | \
            sort -n | \
            tail -1)

          if [ -z "$HIGHEST_ITERATION" ]; then
            NEXT_ITERATION=0
          else
            NEXT_ITERATION=$((HIGHEST_ITERATION + 1))
          fi

          FULL_VERSION="${BASE_VERSION}.${NEXT_ITERATION}"
          echo "version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Next version: $FULL_VERSION"

      - name: Generate MCP server
        id: generate
        run: |
          echo "ðŸ”§ Generating MCP server from OpenAPI spec..."
          npm run generate
          echo "âœ… MCP server generated"

      - name: Update package.json version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "ðŸ“ Updating package.json to version $VERSION"
          npm version "$VERSION" --no-git-tag-version

      - name: Run unit tests
        id: unit-test
        run: |
          echo "ðŸ§ª Running unit tests..."
          npm run test:unit 2>&1 | tee unit-test-output.txt
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT

          if [ "$TEST_EXIT_CODE" -eq 0 ]; then
            echo "âœ… Unit tests passed"
          else
            echo "âŒ Unit tests failed"
          fi
          exit $TEST_EXIT_CODE
        continue-on-error: true

      - name: Run E2E tests
        id: e2e-test
        env:
          E2E_WINDMILL_URL: http://localhost:8000
          E2E_WORKSPACE: demo
          WINDMILL_BASE_URL: http://localhost:8000
        run: |
          echo "ðŸ§ª Running E2E tests..."
          npm run test:e2e 2>&1 | tee e2e-test-output.txt
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT

          if [ "$TEST_EXIT_CODE" -eq 0 ]; then
            echo "âœ… E2E tests passed"
          else
            echo "âš ï¸ E2E tests completed with warnings"
          fi
          exit $TEST_EXIT_CODE
        continue-on-error: true

      - name: Stop Windmill
        if: always()
        run: |
          echo "ðŸ›‘ Stopping Windmill instance..."
          npm run docker:down

      - name: Determine overall test status
        id: test-status
        run: |
          UNIT_EXIT=${{ steps.unit-test.outputs.exit_code || '1' }}
          E2E_EXIT=${{ steps.e2e-test.outputs.exit_code || '0' }}

          # Tests pass if unit tests pass (E2E might have warnings)
          if [ "$UNIT_EXIT" = "0" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… All required tests passed"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Tests failed"
          fi

      - name: Create or checkout version branch
        if: steps.test-status.outputs.passed == 'true'
        run: |
          TARGET_BRANCH="${{ steps.version.outputs.target_branch }}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch all branches
          git fetch origin

          # Check if branch exists on remote
          if git ls-remote --heads origin "$TARGET_BRANCH" | grep -q "$TARGET_BRANCH"; then
            echo "âœ… Branch '$TARGET_BRANCH' exists, checking out..."
            git checkout "$TARGET_BRANCH"
            git pull origin "$TARGET_BRANCH"
          else
            echo "ðŸ“ Creating new branch '$TARGET_BRANCH'..."
            git checkout -b "$TARGET_BRANCH"
          fi

      - name: Commit generated code
        if: steps.test-status.outputs.passed == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SPEC_VERSION="${{ steps.fetch-spec.outputs.spec_version }}"

          # Stage all changes including gitignored src/ directory
          git add -f src/ generator/cache/openapi-spec.json package.json package-lock.json

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "Generate MCP server v${VERSION} for Windmill ${SPEC_VERSION}

- Windmill OpenAPI version: ${SPEC_VERSION}
- MCP server version: ${VERSION}
- Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
- Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            echo "âœ… Changes committed"
          fi

      - name: Create version tag
        if: steps.test-status.outputs.passed == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v${VERSION}"

          # Create annotated tag
          git tag -a "$TAG" -m "MCP Server ${VERSION}

Windmill API version: ${{ steps.fetch-spec.outputs.spec_version }}
Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          echo "âœ… Created tag: $TAG"

      - name: Push to version branch
        if: steps.test-status.outputs.passed == 'true'
        run: |
          TARGET_BRANCH="${{ steps.version.outputs.target_branch }}"

          # Push branch and tags with retry logic
          for i in 1 2 3 4; do
            if git push -u origin "$TARGET_BRANCH" --tags; then
              echo "âœ… Successfully pushed to $TARGET_BRANCH"
              exit 0
            else
              if [ $i -lt 4 ]; then
                WAIT=$((2 ** i))
                echo "âš ï¸ Push failed, retrying in ${WAIT}s..."
                sleep $WAIT
              else
                echo "âŒ Push failed after 4 attempts"
                exit 1
              fi
            fi
          done

      - name: Publish to npm
        if: steps.test-status.outputs.passed == 'true' && (github.event.inputs.publish == 'true' || github.event_name == 'schedule')
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Check if NPM_TOKEN is set
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "âš ï¸ NPM_TOKEN not set, skipping publish"
            echo "To publish, add NPM_TOKEN to repository secrets"
            exit 0
          fi

          echo "ðŸ“¦ Publishing version $VERSION to npm..."

          # Publish to npm
          npm publish --access public

          echo "âœ… Published to npm"
          echo "Users can now run: npx windmill-mcp@${VERSION}"

      - name: Create draft PR for failed tests
        if: steps.test-status.outputs.passed == 'false'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: '[DRAFT] Generate MCP server for Windmill ${{ steps.fetch-spec.outputs.spec_version }}'
          branch: draft-${{ steps.version.outputs.target_branch }}-${{ github.run_number }}
          base: ${{ steps.version.outputs.target_branch }}
          delete-branch: true
          title: '[DRAFT] MCP Server for Windmill ${{ steps.fetch-spec.outputs.spec_version }} - Tests Failed'
          draft: true
          add-paths: |
            src/**
            generator/cache/**
            package.json
            package-lock.json
          body: |
            ## âš ï¸ Generated MCP Server - Tests Failed

            **Windmill Version**: ${{ steps.fetch-spec.outputs.spec_version }}
            **Target Version**: ${{ steps.version.outputs.version }}
            **Target Branch**: `${{ steps.version.outputs.target_branch }}`

            ### Test Results
            **Unit Tests:** ${{ steps.unit-test.outputs.exit_code == '0' && 'âœ… Passed' || 'âŒ Failed' }}
            **E2E Tests:** ${{ steps.e2e-test.outputs.exit_code == '0' && 'âœ… Passed' || 'âš ï¸ Warnings' }}

            ### Action Required
            This PR was created as a draft because tests failed. Please:
            1. Review test failures in the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            2. Fix issues locally or in this PR
            3. Re-run tests
            4. Merge when tests pass

            ---

            **Note**: This is a draft PR and will not be automatically merged.
          labels: |
            automated
            tests-failing
            needs-review

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ steps.version.outputs.version }}
          path: |
            unit-test-output.txt
            e2e-test-output.txt
            generator/cache/openapi-spec.json
          retention-days: 30

      - name: Workflow Summary
        if: always()
        run: |
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Windmill API Version**: ${{ steps.fetch-spec.outputs.spec_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **MCP Server Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Branch**: \`${{ steps.version.outputs.target_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests Passed**: ${{ steps.test-status.outputs.passed == 'true' && 'âœ… Yes' || 'âŒ No' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.test-status.outputs.passed }}" = "true" ]; then
            echo "### âœ… Success!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The MCP server was generated, tested, and published successfully." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Installation:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "# Latest version for this Windmill release" >> $GITHUB_STEP_SUMMARY
            echo "npx windmill-mcp@${{ steps.fetch-spec.outputs.spec_version }}-mcp" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Specific iteration" >> $GITHUB_STEP_SUMMARY
            echo "npx windmill-mcp@${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# From Git branch (alternative)" >> $GITHUB_STEP_SUMMARY
            echo "npx github:rothnic/windmill-mcp#${{ steps.version.outputs.target_branch }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A draft PR was created for review. Please check test failures and fix issues." >> $GITHUB_STEP_SUMMARY
          fi
