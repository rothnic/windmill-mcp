# Minimal Windmill Docker Setup for E2E Testing
#
# This is a simplified single-container setup for testing purposes.
# For production, use the full multi-container setup from Windmill docs.

# Minimal Windmill Docker Setup for E2E Testing

# Define all available tags for maximum worker coverage
x-windmill-all-tags: &windmill-all-tags deno,python3,bash,go,powershell,dependency,flow,other,bun,php,rust,ansible,nativets,postgresql,mysql,graphql,snowflake,mssql,bigquery,csharp,java,ruby

# Define common configuration using YAML anchors
x-windmill-common-env: &windmill-common-env
  DATABASE_URL: postgresql://postgres:changeme@windmill-db:5432/windmill?sslmode=disable
  SUPERADMIN_SECRET: test-super-secret
  RUST_LOG: info
  BASE_URL: http://localhost:8000
  # Set all possible worker tags
  WORKER_TAGS: *windmill-all-tags

x-windmill-image: &windmill-image ghcr.io/windmill-labs/windmill:main

services:
  # Windmill server (only server mode)
  windmill-server:
    image: *windmill-image
    container_name: windmill-server-test
    ports:
      - "8000:8000"
    environment:
      # Inherit common environment variables
      <<: *windmill-common-env
      MODE: server # Explicitly set mode to server only
      NUM_WORKERS: 0 # Disable embedded workers
      DISABLE_NSJAIL: true

    volumes:
      - windmill_data:/tmp/windmill

    depends_on:
      windmill-db:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/version"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Dedicated Windmill worker service, configured for all tags
  windmill-worker:
    image: *windmill-image
    container_name: windmill-worker-test
    restart: unless-stopped
    environment:
      # Inherit common environment variables, including all tags
      <<: *windmill-common-env
      MODE: worker # Explicitly set mode to worker

  # PostgreSQL database
  windmill-db:
    image: postgres:14
    container_name: windmill-db-test
    environment:
      POSTGRES_PASSWORD: changeme
      POSTGRES_DB: windmill

    volumes:
      - windmill_db_data:/var/lib/postgresql/data

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

    ports:
      - "5432:5432"

volumes:
  windmill_data:
  windmill_db_data:
