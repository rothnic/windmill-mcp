# E2E Testing with Windmill CLI

This document describes the CLI-based approach for setting up and running E2E tests against a Windmill instance.

## Overview

The E2E testing setup uses the **Windmill CLI (`wmill`)** to:

1. ✅ Create test users programmatically
2. ✅ Generate API tokens (tests real auth flow)
3. ✅ Seed test data (scripts, workflows, resources)
4. ✅ Enable fully automated CI/CD testing

## Why CLI-based Testing?

### Previous Approach (SUPERADMIN_SECRET)
```yaml
env:
  E2E_WINDMILL_TOKEN: test-super-secret  # Hardcoded admin bypass
```

**Issues:**
- Bypasses normal authentication
- No test user creation
- No test data seeding
- Less realistic testing

### New Approach (Windmill CLI)
```bash
npm run setup:e2e  # Installs CLI, creates user, generates token, seeds data
```

**Benefits:**
- ✅ Tests real authentication flow
- ✅ Programmatic user and token creation
- ✅ Automated test data seeding
- ✅ Reproducible across environments
- ✅ More secure (tokens generated on-demand)

## Quick Start

### Local Development

```bash
# 1. Start Windmill
npm run docker:up

# 2. Setup E2E environment (CLI-based)
npm run setup:e2e

# 3. Run E2E tests
npm run test:e2e

# 4. Cleanup
npm run docker:down
```

Or run everything at once:
```bash
npm run test:e2e:full
```

### What `setup:e2e` Does

The `npm run setup:e2e` script (`tests/setup-windmill.sh`):

1. **Installs Windmill CLI**
   ```bash
   npm install -g windmill-cli
   ```

2. **Waits for Windmill** to be ready
   ```bash
   curl http://localhost:8000/api/version
   ```

3. **Creates test user** (using SUPERADMIN_SECRET for bootstrapping only)
   ```bash
   curl -X POST /api/users/create \
     -H "Authorization: Bearer $SUPERADMIN_SECRET" \
     -d '{"email": "test@windmill.dev", "password": "test-password-123"}'
   ```

4. **Generates API token** (via CLI, tests real auth)
   ```bash
   wmill user login test@windmill.dev --password test-password-123
   ```

5. **Seeds test data** (scripts, workflows, resources)
   ```bash
   npm run seed:test-data
   ```

6. **Exports environment variables**
   ```bash
   export E2E_WINDMILL_TOKEN=<generated-token>
   echo "E2E_WINDMILL_TOKEN=..." > tests/.env.test
   ```

## Test Data Seeding

The `npm run seed:test-data` script creates:

### Scripts
- `f/examples/test_python_script` - Python test script
- `f/examples/test_deno_script` - TypeScript/Deno test script
- `f/examples/test_bash_script` - Bash test script

### Workflows
- `f/examples/test_workflow` - Multi-step test workflow

### Resources
- `f/examples/test_resource` - Generic API resource
- `f/examples/test_database` - PostgreSQL resource

### Variables
- `f/examples/test_var` - Public variable
- `f/examples/test_secret` - Secret variable

### Jobs
- Runs `test_python_script` to generate job history

## CI/CD Integration

### GitHub Actions Workflow

```yaml
e2e-tests:
  runs-on: ubuntu-latest

  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm ci

    - name: Start Windmill
      run: npm run docker:up

    - name: Setup Windmill with CLI
      run: npm run setup:e2e
      env:
        E2E_WINDMILL_URL: http://localhost:8000
        E2E_WORKSPACE: demo
        SUPERADMIN_SECRET: test-super-secret

    - name: Run E2E tests
      run: npm run test:e2e

    - name: Stop Windmill
      if: always()
      run: npm run docker:down
```

## Environment Variables

### Required for Setup

| Variable | Description | Default |
|----------|-------------|---------|
| `E2E_WINDMILL_URL` | Windmill instance URL | `http://localhost:8000` |
| `E2E_WORKSPACE` | Workspace name | `demo` |
| `SUPERADMIN_SECRET` | Admin secret (bootstrapping only) | `test-super-secret` |

### Optional Configuration

| Variable | Description | Default |
|----------|-------------|---------|
| `TEST_USER_EMAIL` | Test user email | `test@windmill.dev` |
| `TEST_USER_PASSWORD` | Test user password | `test-password-123` |

### Generated by Setup

| Variable | Description | Source |
|----------|-------------|--------|
| `E2E_WINDMILL_TOKEN` | API token for tests | Generated by `wmill user login` |

## Manual Setup (without CLI)

If you need to set up manually:

1. **Start Windmill**
   ```bash
   npm run docker:up
   ```

2. **Access UI**: http://localhost:8000

3. **Create Account** (or login with existing)

4. **Generate Token**:
   - Go to User Settings → Tokens
   - Create new token
   - Copy token value

5. **Set Environment Variable**
   ```bash
   export E2E_WINDMILL_TOKEN=your-token-here
   ```

6. **Run Tests**
   ```bash
   npm run test:e2e
   ```

## Troubleshooting

### CLI Installation Fails

**Problem**: `npm install -g windmill-cli` fails

**Solution**: Check npm permissions or use `sudo`:
```bash
sudo npm install -g windmill-cli
```

Or install locally:
```bash
npm install windmill-cli
npx wmill --version
```

### User Creation Fails

**Problem**: "User already exists" error

**Solution**: This is normal - the script continues with existing user. If you need to reset:
```bash
# Stop and remove volumes
npm run docker:down
docker volume rm windmill-mcp_windmill_data windmill-mcp_windmill_db_data

# Start fresh
npm run docker:up
npm run setup:e2e
```

### Token Generation Fails

**Problem**: `wmill user login` fails

**Solution**: The script falls back to SUPERADMIN_SECRET. To debug:
```bash
# Check Windmill is accessible
curl http://localhost:8000/api/version

# Try manual login
wmill user login test@windmill.dev --password test-password-123

# Check logs
npm run docker:logs
```

### Tests Can't Find Token

**Problem**: Tests skip with "E2E tests skipped - no token"

**Solution**: Source the environment file:
```bash
source tests/.env.test
npm run test:e2e
```

Or set manually:
```bash
export E2E_WINDMILL_TOKEN=$(cat tests/.env.test | grep E2E_WINDMILL_TOKEN | cut -d'=' -f2)
npm run test:e2e
```

## Comparison: CLI vs Manual vs SUPERADMIN_SECRET

| Feature | CLI (Recommended) | Manual | SUPERADMIN_SECRET |
|---------|------------------|--------|-------------------|
| **Automation** | ✅ Fully automated | ❌ Manual steps | ✅ Automated |
| **Auth Testing** | ✅ Real flow | ✅ Real flow | ⚠️ Bypasses auth |
| **Data Seeding** | ✅ Scripted | ❌ Manual | ❌ None |
| **Reproducibility** | ✅ Perfect | ⚠️ Error-prone | ✅ Good |
| **Security** | ✅ Tokens on-demand | ✅ User tokens | ⚠️ Admin secret |
| **CI/CD** | ✅ Ideal | ❌ Not feasible | ✅ Works |
| **Setup Time** | ~30 seconds | ~2-5 minutes | ~10 seconds |

## Best Practices

1. **Use CLI for CI/CD**: Fully automated and reproducible
2. **Keep SUPERADMIN_SECRET for bootstrapping only**: Only use it to create the initial user
3. **Seed realistic test data**: Tests should run against data similar to production
4. **Clean up between runs**: Use `docker:down` to ensure fresh state
5. **Version lock wmill**: Consider pinning `windmill-cli` version in package.json

## Scripts Reference

| Script | Command | Description |
|--------|---------|-------------|
| Setup E2E | `npm run setup:e2e` | Full setup (CLI install, user, token, data) |
| Seed Data | `npm run seed:test-data` | Only seed test data |
| Docker Up | `npm run docker:up` | Start Windmill containers |
| Docker Down | `npm run docker:down` | Stop and remove containers |
| Docker Wait | `npm run docker:wait` | Wait for Windmill ready |
| Run E2E | `npm run test:e2e` | Run E2E tests |
| Full Cycle | `npm run test:e2e:full` | Start → Setup → Test → Stop |

## Next Steps

- Consider adding more test data scenarios
- Add cleanup script to remove test data
- Create fixtures for complex workflows
- Add performance benchmarking to E2E tests
- Document custom test data creation

## Resources

- [Windmill CLI Documentation](https://www.windmill.dev/docs/advanced/cli)
- [Windmill API Reference](https://www.windmill.dev/docs/core_concepts/api)
- [Test Data Seeding Script](./seed-test-data.sh)
- [Setup Script](./setup-windmill.sh)
